<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Descarga masiva - Evaluación de Derechos Humanos</title>
		
		<!-- CSS -->
	    <link href="/favicon.ico" rel="shortcut icon">
	    <link href="https://framework-gb.cdn.gob.mx/assets/styles/main.css" rel="stylesheet">
	    
	    <link href="css/generales.css" rel="stylesheet">
		
		<!-- Respond.js soporte de media queries para Internet Explorer 8 -->
	    <!-- ie8.js EventTarget para cada nodo en Internet Explorer 8 -->
	    <!--[if lt IE 9]>
	      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	      <script src="https://cdnjs.cloudflare.com/ajax/libs/ie8/0.2.2/ie8.js"></script>
	    <![endif]-->
	</head>
	<body>
		
		<!-- Contenido -->
	    <main class="page">
		    
		    
		    <nav class="navbar navbar-inverse sub-navbar navbar-fixed-top">
			  <div class="container">
			    <div class="navbar-header">
			      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#subenlaces">
			        <span class="sr-only">Interruptor de Navegación</span>
			        <span class="icon-bar"></span>
			        <span class="icon-bar"></span>
			        <span class="icon-bar"></span>
			      </button>
			      <a class="navbar-brand" href="index.html"><img src="img/DH.png" alt="" class="logomenu" /></a>
			    </div>
			    <div class="collapse navbar-collapse" id="subenlaces">
			      <ul class="nav navbar-nav navbar-right">
			        <li><a href="acerca.html" >Acerca de</a></li>
			        <li><a href="derechos.html">Derechos</a></li>
<!--			        <li><a href="calendario.html">Calendario</a></li>-->
			        <li class="active"><a href="descarga.html">Descarga masiva</a></li>
			        <li><a href="contacto.html">Contacto</a></li>
			        <li><a href="busqueda.html"><span class="icon-search" aria-hidden="true"></span></a></li>
			      </ul>
			    </div>
			  </div>
			</nav>
		    
		  
<!--
			<div class="row header">
		      <div class="col-md-12 titulo-header">
			      <h1>Acerca de</h1>
		      </div>
	      	</div>
-->
			<br/><br/>
			<div class="container">
				<ol class="breadcrumb">
					<li><a href="index.html"><i class="icon icon-home"></i></a></li>
					<li class="active">Descarga masiva</li>
				</ol>
			</div>
            
    <form id="formulario">
	      <div class="container">
		      <br /><br />
		  	<!-- Inicia Bloque -->
		      <div class="row">
			      <div class="col-md-12" >
				      <h1>Descarga masiva de datos</h1>
				      <hr />
                      <div class="container">
                            <div class="row">
                                <p>En la siguiente sección podrás descargar toda la información contenida en los indicadores de manera masiva. Para hacerlo tendras que: </p>
                                <ol>
                                    <li>Selecciona el formato en el que quieras descargar la información (XLS o CSV)</li>
                                    <li>Seleccionar el/los derechos que aparecen debajo</li>
                                    <li>Seleccionar los indicadores. </li>
                                    <li>Dar click en el botón de descarga</li>
                                    <li>Espera a que se genere la liga para descargar los archivos correspondientes en formato zip</li>
                                </ol>
                            </div>
                        </div>
            
                      <br /><br />
                      
				      <div class="row" id="filtroDescarga">
					      <div class="col-md-3">
						      <h6>Elementos a exportar</h6>
					      </div>

					      <div class="col-md-4">
							  <select class="form-control" placeholder="Tipo de formato" id="tipoFormato" name="tipoFormato">
								  <option id="tipoXLS" value="xls" selected>XLS</option>
								  <option id="tipoCSV" value="csv">CSV</option>
								</select>
					      </div>
					      <div class="col-md-3">
						      <button type="button" id="descargarDatos" class="btn btn-primary">Descargar datos</button>
					      </div>
					  	
				      </div>
				      <br /><br />
				      <div class="row">
					      
					      <div class="panel-group ficha-collapse" id="accordions"></div>
					  	
                          <div id="descargaZip" style="text-align: center;">
                              <div class="caja">
                                  <h5 id="mensajeDescarga">Se está generando su carpeta de descarga</h5>
                                  <div style="margin:0 auto;text-align:center;" class="loadload">
                                    <div class="preloader-wrapper big active">
                                      <div class="spinner-layer spinner-blue-only">
                                        <div class="circle-clipper left">
                                          <div class="circle"></div>
                                        </div><div class="gap-patch">
                                          <div class="circle"></div>
                                        </div><div class="circle-clipper right">
                                          <div class="circle"></div>
                                        </div>
                                      </div>
                                    </div>
                                </div>
                                <div id="resp">

                                </div>
                                <br/>
                                <br/>
                                <div class="cerrar">
                                    <button type="button" id="nuevaDescarga" class="btn btn-primary" onclick="javascript:window.location.reload();">Reiniciar selección de indicadores</button>
                                </div>
                              </div>
                            </div>
                          
                          
				      </div>
				      
			      </div>
		      </div>
		      <!-- Termina Bloque -->      
		      <input type="hidden" value="" id="indPost" name="indicadores" />
	      </div>
    </form>
		  <br /><br />
            

	    </main>
	
	    <!-- JS -->
	    <script src="https://framework-gb.cdn.gob.mx/gobmx.js"></script>
	    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
			  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
			  crossorigin="anonymous"></script>
	    <script src="js/main.js"></script>
        <script src="js/consultas.js"></script>
        <script>
        $('#descargaZip').hide();
            $('#nuevaDescarga').hide();
            
          var colap = '';
            var indDer = ['Culturales','Medio Ambiente','Trabajo','Alimentación','Sindicales'];
            
            function listaInd(){
                for(var i=0;i<indDer.length;i++){
                    colap += '<div class="panel panel-default">'+
                            '        <div class="panel-heading d'+(i+1)+'">'+
                            '            <h4 class="panel-title">'+
                            '                <a data-parent="#accordion" data-toggle="collapse" href="#panel-0'+i+'" aria-expanded="false" aria-controls="panel-0'+i+'" style="color:#ffffff;">'+indDer[i]+'</a>'+
                            '            </h4>'+
                            '            <button type="button" class="collpase-button collapsed" data-parent="#accordion" data-toggle="collapse" href="#panel-0'+i+'"></button>'+
                            '        </div>'+
                            '        <div class="panel-collapse collapse" id="panel-0'+i+'">'+
                            '            <div class="panel-body">'+
                            '                <div id="cargaDat'+i+'">'+getValores(indDer[i])+'</div>'+
                            '            </div>'+
                            '        </div>'+
                            '    </div>';
                }
                return colap;
            }
            
            function getValores(derecho){
                var valores = '';

                 $.ajax({
                  type: 'GET',
                  url: pathAPI + "search?q=right_name_short_lit:"+derecho+"&rows=100",
                     //url: pathAPI + "search?q=right_id:"+derecho+"&rows=100",
                  data: {},
                  success: function( data, textStatus, jqxhr ) {

                      tipoDer = data['results']['records'];

                      console.log(tipoDer);
                      for(var g = 0;g<tipoDer.length;g++){
                        if(tipoDer[g].is_cuantitative === true && tipoDer[g].breakdown_attribute_result != null){
                            valores += '<div class="CT"><label style="font-weight:400;"><input type="checkbox" name="'+tipoDer[g].indicator_code+'"> ' + tipoDer[g].indicator_code + ' - ' + tipoDer[g].indicator_name + ' <span class="d1" style="color:#fff;padding:3px 5px;font-size:11px;border-radius:4px;" title="Indicador Cuantitativo">CT</span></label><br /></div>';
                         }else if(tipoDer[g].is_cuantitative === false){
                              valores += '<div class="CL"><label style="font-weight:400;"><input type="checkbox" name="'+tipoDer[g].indicator_code+'"> ' + tipoDer[g].indicator_code + ' - ' + tipoDer[g].indicator_name + ' <span class="d1" title="Indicador Cualitativo" style="color:#fff;opacity:0.7;padding:3px 5px;font-size:11px;border-radius:4px;">CL</span></label><br /></div>';
                                  }
                      }

                  },
                  async:false
                });
                console.log(valores);
                return valores;
            }
            
            $('#accordions').html(listaInd());
            
            
            // Acciones para la descarga
            $('#descargarDatos').on('click',function(e){
                $(this).hide();
                $('#nuevaDescarga').show();
                $('#accordions').hide();
                $('#filtroDescarga').hide();
                $('#descargaZip').show();
                
              e.preventDefault();
              var indica = [];
              var valor='';
              var n = $('#accordions input[type=checkbox]:checked');
              console.log(n);


              if(n != '' || n != null){
                $.each(n, function(){
                     console.log($(this).attr('name'));
                     valor  +=  ',' + $(this).attr('name');
                });
              }else{
                alert('Debes seleccionar al menos 1 indicador.');
              }

                console.log(valor);
                
                $('#indPost').val(valor);
                
                // Variable de lo seleccionado en string separado por comas
                var iji = valor.substr(1);
                console.log(iji);

                var resol = iji.split(",");
                
                var url = "descargaMasiva/descargaMasiva.php";
                $.ajax({
                   type: "POST",
                   url: url,
                   data: $("#formulario").serialize(),
                   success: function(data)
                   {
                     $('#resp').html(data);
                     $('.loadload').hide();
                     $('.cerrar').show();
                     $('#mensajeDescarga').html('Se ha generado su carpeta de descarga. Haga click en el siguiente enlace para descargar.<br/><br/>');
                     //exit();

                   },
                   async: false
               });
                
                
//                for(var ll=0;ll<resol.length;ll++){
//                    var url = pathAPI + "data/PUDH:INDI:" + resol[ll];
//                    var indContd = '';
//                    $.ajax({
//                       type: "GET",
//                       url: url,
//                       success: function(data)
//                       {
//                            indContd = '<tr><td>'+data.right_name_short+'</td><td>'+data.indicator_code+'</td><td>'+data.indicator_name+'</td><td>'+data.indicator_category_name+'</td><td>'+data.indicator_type_short+'</td>';
//                           var tipoInfo = (data.is_cuantitative === true) ? "Cuantitativo" : "Cualitativo";
//                           indContd += '<td>'+tipoInfo+'</td><td><a href="indicadores.html?codigo=PUDH:INDI:'+data.indicator_code+'" target="_blank">Indicador '+data.indicator_code+'</a></td></tr>';
//                           
//                           console.log(indContd);
//                           
//                            $('#tabuladoInsumo table tbody').append(indContd);
//                       },
//                       async: true
//                   });
//                }
                

      });
        
        </script>
		
	</body>
</html>